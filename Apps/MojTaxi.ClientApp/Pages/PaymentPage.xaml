<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MojTaxi.ClientApp.ViewModels"
             xmlns:converters="clr-namespace:MojTaxi.ClientApp.Converters"
             x:Class="MojTaxi.ClientApp.Pages.PaymentPage"
             x:Name="ThisPage"
             Shell.NavBarIsVisible="True"
             BackgroundColor="#0B1120"
             Title="Plaćanje">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolToDefaultTextConverter x:Key="BoolToDefaultTextConverter" />
            <converters:BoolToDefaultBgConverter x:Key="BoolToDefaultBgConverter" />
            <converters:BoolToDefaultTextColorConverter x:Key="BoolToDefaultTextColorConverter" />
            <converters:BoolToDefaultIconColorConverter x:Key="BoolToDefaultIconColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.BindingContext>
        <vm:PaymentViewModel />
    </ContentPage.BindingContext>

    <VerticalStackLayout Padding="20" Spacing="16">

        <Label Text="Sačuvane kartice"
               TextColor="White"
               FontSize="20"
               FontAttributes="Bold" />

        <CollectionView ItemsSource="{Binding Cards}"
                        SelectionMode="Single"
                        SelectedItem="{Binding SelectedCard, Mode=TwoWay}">

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Border StrokeShape="RoundRectangle 18"
        BackgroundColor="#111827"
        Padding="16"
        Margin="0,10"
        HeightRequest="190">

                        <Grid RowDefinitions="Auto,*,Auto">

                            <!-- TOP ROW -->
                            <Grid Grid.Row="0" ColumnDefinitions="*,Auto" VerticalOptions="Center">

                                <Label Text="{Binding BrandName}"
                   FontSize="16"
                   TextColor="#9CA3AF" />

                                <!-- Brand icon -->
                                <Label Grid.Column="1"
                   Text="{Binding BrandIcon}"
                   FontFamily="MaterialIcons"
                   FontSize="36"
                   TextColor="#FEF000" />
                            </Grid>

                            <!-- CARD NUMBER -->
                            <VerticalStackLayout Grid.Row="1"
                     Spacing="4"
                     VerticalOptions="Center">

                                <!-- Maskirani broj -->
                                <Label Text="{Binding MaskedNumber}"
           FontSize="26"
           FontAttributes="Bold"
           FontFamily="Consolas"
           TextColor="White" />

                                <!-- Card holder -->
                                <Label Text="{Binding CardHolder}"
           FontSize="16"
           TextColor="#9CA3AF"
           TextTransform="Uppercase" />
                            </VerticalStackLayout>

                            <!-- BOTTOM ROW -->
                            <Grid Grid.Row="2" ColumnDefinitions="*,Auto" VerticalOptions="Center">

                                <!-- Expiry -->
                                <VerticalStackLayout Spacing="2">
                                    <Label Text="EXPIRY"
                       FontSize="10"
                       TextColor="#6B7280" />
                                    <Label Text="{Binding Expiry}"
                       FontSize="14"
                       FontAttributes="Bold"
                       TextColor="White" />
                                </VerticalStackLayout>

                                <!-- ACTION ICONS -->
                                <HorizontalStackLayout Grid.Column="1"
                                   Spacing="12"
                                   HorizontalOptions="End">

                                    <!-- DEFAULT -->
                                    <Button FontFamily="MaterialIcons"
                        Text="&#xE838;"
                        FontSize="22"
                        BackgroundColor="Transparent"
                        TextColor="{Binding IsDefault, Converter={StaticResource BoolToDefaultIconColorConverter}}"
                        Command="{Binding Path=BindingContext.SetDefaultCommand, Source={x:Reference ThisPage}}"
                        CommandParameter="{Binding .}" />

                                    <!-- DELETE -->
                                    <Button FontFamily="MaterialIcons"
                        Text="&#xE872;"
                        FontSize="22"
                        BackgroundColor="Transparent"
                        TextColor="#F87171"
                        Command="{Binding Path=BindingContext.DeleteCardCommand, Source={x:Reference ThisPage}}"
                        CommandParameter="{Binding .}" />
                                </HorizontalStackLayout>

                            </Grid>
                        </Grid>
                    </Border>

                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- ADD CARD (PRIMARY CTA) -->
        <Button Text="+ Dodaj karticu"
                Command="{Binding AddPaymentMethodCommand}"
                BackgroundColor="#FEF000"
                TextColor="Black"
                CornerRadius="14"
                HeightRequest="52"
                FontAttributes="Bold" />

    </VerticalStackLayout>
</ContentPage>
